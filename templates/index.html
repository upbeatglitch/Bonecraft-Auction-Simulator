<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonecraft Sim (Cloud)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #333; color: #eee; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background-color: #444; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        h1, h2, h3 { color: #8af; border-bottom: 2px solid #555; padding-bottom: 5px; margin-top: 20px; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #555; border-radius: 4px; background-color: #555; }
        input[type="text"], input[type="password"], input[type="number"], select { padding: 10px; margin: 5px 0; border: 1px solid #777; border-radius: 4px; background-color: #666; color: #fff; width: calc(100% - 22px); box-sizing: border-box; }
        button { background-color: #8af; color: #111; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background-color: #bdf; }
        .button-group button { margin-right: 10px; width: auto; }
        .alert { padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .alert-success { background-color: #4CAF50; color: white; }
        .alert-error { background-color: #f44336; color: white; }
        .player-info { display: flex; justify-content: space-around; background-color: #666; padding: 10px; border-radius: 4px; margin-bottom: 15px; }
        .player-info div { text-align: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border: 1px solid #666; text-align: left; }
        th { background-color: #777; color: #111; }
        td:nth-child(2), td:nth-child(3) { text-align: right; } /* Price and Qty columns */
        .market-action { width: 100px; text-align: center; }

        .recipe-list { max-height: 400px; overflow-y: auto; }
        .recipe-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dotted #666; }
        .recipe-details { flex-grow: 1; }
        .recipe-synth-button { margin-left: 10px; width: 80px; }

    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ¦´ Bonecraft Simulator (Cloud)</h1>
    <p id="statusMessage" class="alert"></p>

    <div id="authSection" class="section">
        <h2>Account</h2>
        <input type="text" id="authUsername" placeholder="Username" required>
        <input type="password" id="authPassword" placeholder="Password" required>
        <div class="button-group">
            <button onclick="handleRegister()">Register</button>
            <button onclick="handleLogin()">Login</button>
        </div>
    </div>

    <div id="gameSection" style="display: none;">
        <div class="player-info section">
            <div>Username: <span id="playerUsername"></span></div>
            <div>Gil: <span id="playerGil"></span></div>
            <div>Total Synths: <span id="playerSynths"></span></div>
            <button onclick="handleLogout()">Logout</button>
        </div>

        <div class="section">
            <h2>Crafting Bench</h2>
            <div id="recipeList" class="recipe-list">
                <p>Loading recipes...</p>
            </div>
        </div>

        <div class="section">
            <h2>Your Inventory & Listing</h2>
            <div id="inventoryList">
                <p>Loading inventory...</p>
            </div>
            
            <h3>List Item on Auction House (AH)</h3>
            <select id="listItemSelect">
                <option value="" disabled selected>Select Item</option>
            </select>
            <input type="number" id="listPrice" placeholder="Total Price (Gil)" min="1" value="1000">
            <input type="number" id="listQty" placeholder="Quantity" min="1" value="1">
            <button onclick="handleListItem()">List Item</button>
        </div>
        
        <div class="section">
            <h2>Auction House (AH)</h2>
            <button onclick="refreshMarket()">Refresh Market</button>
            <table id="marketTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th style="text-align: right;">Price</th>
                        <th style="text-align: right;">Qty</th>
                        <th>Seller</th>
                        <th class="market-action">Action</th> </tr>
                </thead>
                <tbody id="marketListings">
                    </tbody>
            </table>
        </div>

        <div class="section">
            <h2>Leaderboard</h2>
            <button onclick="displayLeaderboard()">Refresh Leaderboard</button>
            <table id="leaderboardTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th style="text-align: right;">Gil</th>
                        <th style="text-align: right;">Synths</th>
                    </tr>
                </thead>
                <tbody id="leaderboardList">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let player = null;
    let recipes = [];
    const statusMessage = document.getElementById('statusMessage');

    // =================================
    // UTILITY FUNCTIONS
    // =================================

    function formatGil(amount) {
        return amount.toLocaleString() + 'g';
    }

    function setStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.className = isError ? 'alert alert-error' : 'alert alert-success';
        if (!message) statusMessage.style.display = 'none';
        else statusMessage.style.display = 'block';
    }

    // =================================
    // AUTHENTICATION HANDLERS
    // =================================

    async function handleRegister() {
        const username = document.getElementById('authUsername').value;
        const password = document.getElementById('authPassword').value;

        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await response.json();
        
        setStatus(data.message, !data.success);
    }

    async function handleLogin() {
        const username = document.getElementById('authUsername').value;
        const password = document.getElementById('authPassword').value;

        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await response.json();
        
        setStatus(data.message, !data.success);
        if (data.success) {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            document.getElementById('playerUsername').textContent = data.username;
            await syncPlayerData();
        }
    }

    async function handleLogout() {
        await fetch('/api/auth/logout', { method: 'POST' });
        player = null;
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('gameSection').style.display = 'none';
        setStatus("Logged out successfully.");
    }

    // =================================
    // GAME & DATA SYNC
    // =================================
    
    async function syncPlayerData() {
        const response = await fetch('/api/game/sync');
        const data = await response.json();

        if (data.success) {
            player = data.player;
            recipes = data.recipes;
            displayPlayerInfo();
            displayInventory();
            displayRecipes();
            refreshMarket(); // Initial market refresh
            displayLeaderboard(); // Initial leaderboard load
        } else {
            // Handle not authenticated (e.g., session expired)
            handleLogout();
        }
    }

    function displayPlayerInfo() {
        if (!player) return;
        document.getElementById('playerGil').textContent = formatGil(player.gil);
        document.getElementById('playerSynths').textContent = player.total_synths.toLocaleString();
    }
    
    function displayInventory() {
        if (!player) return;
        const inventoryDiv = document.getElementById('inventoryList');
        const listSelect = document.getElementById('listItemSelect');
        inventoryDiv.innerHTML = '';
        listSelect.innerHTML = '<option value="" disabled selected>Select Item</option>';
        
        let html = '<ul>';
        for (const [item, qty] of Object.entries(player.inventory).sort()) {
            html += `<li>${item}: ${qty.toLocaleString()}</li>`;
            listSelect.innerHTML += `<option value="${item}">${item} (${qty.toLocaleString()} available)</option>`;
        }
        html += '</ul>';
        inventoryDiv.innerHTML = html;
    }

    function displayRecipes() {
        const recipeList = document.getElementById('recipeList');
        recipeList.innerHTML = '';
        
        for (const recipe of recipes.sort((a, b) => b.tier - a.tier)) {
            const hasMaterial = player.inventory[recipe.material] >= recipe.qty;
            const canAfford = player.gil >= recipe.price * 0.1;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'recipe-item';
            
            itemDiv.innerHTML = `
                <div class="recipe-details">
                    <strong>${recipe.name}</strong> (T${recipe.tier})<br>
                    Cost: ${formatGil(recipe.price * 0.1)} Fee | Mat: ${recipe.qty}x ${recipe.material}
                </div>
                <button class="recipe-synth-button" 
                        onclick="handleSynth('${recipe.name}')" 
                        ${(!hasMaterial || !canAfford) ? 'disabled' : ''}>
                    Synth
                </button>
            `;
            recipeList.appendChild(itemDiv);
        }
    }

    async function handleSynth(recipeName) {
        if (!player) return;
        
        const response = await fetch('/api/game/synth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ recipe_name: recipeName })
        });
        const data = await response.json();
        
        setStatus(data.message, data.result === 'BREAK' || !data.success);
        
        if (data.success) {
            player = data.player;
            displayPlayerInfo();
            displayInventory();
            displayRecipes(); // Update button states
        }
    }

    // =================================
    // AUCTION HOUSE HANDLERS
    // =================================
    
    async function refreshMarket() {
        const response = await fetch('/api/ah/market');
        const data = await response.json();
        
        if (data.success) {
            displayMarketListings(data.listings);
        } else {
            setStatus("Failed to load market listings.", true);
        }
    }

    function displayMarketListings(listings) {
        const marketBody = document.getElementById('marketListings');
        marketBody.innerHTML = '';

        if (listings.length === 0) {
            marketBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No items currently listed.</td></tr>';
            return;
        }

        for (const listing of listings) {
            const row = marketBody.insertRow();
            const unitPrice = listing.price / listing.qty;
            
            row.innerHTML = `
                <td>${listing.item}</td>
                <td style="text-align: right;">${formatGil(listing.price)} (${formatGil(unitPrice)}/ea)</td>
                <td style="text-align: right;">${listing.qty.toLocaleString()}</td>
                <td>${listing.seller}</td>
                <td class="market-action">
                    <button onclick="handleBuyItem('${listing.id}', ${listing.price})" 
                            ${player && player.gil < listing.price ? 'disabled' : ''}>
                        Buy
                    </button>
                </td>
            `;
        }
    }

    // *** NEW FUNCTION TO HANDLE BUYING ***
    async function handleBuyItem(listingId, price) {
        if (!player) {
            setStatus("You must be logged in to buy items.", true);
            return;
        }
        if (player.gil < price) {
            setStatus("You do not have enough Gil for this purchase.", true);
            return;
        }

        const response = await fetch('/api/ah/buy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ listing_id: listingId })
        });
        const data = await response.json();

        if (data.success) {
            setStatus(data.message);
            player = data.player;
            displayPlayerInfo();
            displayInventory();
            refreshMarket(); // Refresh market to remove the sold item
        } else {
            setStatus("Purchase failed: " + data.message, true);
            refreshMarket(); // Refresh market in case the item was sold to someone else
        }
    }
    // ************************************

    async function handleListItem() {
        if (!player) return;

        const item_name = document.getElementById('listItemSelect').value;
        const price = parseInt(document.getElementById('listPrice').value);
        const qty = parseInt(document.getElementById('listQty').value);

        if (!item_name || isNaN(price) || price <= 0 || isNaN(qty) || qty <= 0) {
            setStatus("Please provide valid item, price, and quantity.", true);
            return;
        }

        const response = await fetch('/api/ah/list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item: item_name, price: price, qty: qty })
        });
        const data = await response.json();

        setStatus(data.message, !data.success);

        if (data.success) {
            // Need to re-sync player data to update inventory correctly after listing
            await syncPlayerData();
            refreshMarket();
        }
    }

    // =================================
    // LEADERBOARD HANDLERS
    // =================================

    async function displayLeaderboard() {
        const response = await fetch('/api/game/leaderboard');
        const data = await response.json();

        const leaderboardBody = document.getElementById('leaderboardList');
        leaderboardBody.innerHTML = '';

        if (data.success) {
            if (data.leaderboard.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No player data available.</td></tr>';
                return;
            }

            data.leaderboard.forEach((entry, index) => {
                const row = leaderboardBody.insertRow();
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${entry.name}</td>
                    <td style="text-align: right;">${formatGil(entry.gil)}</td>
                    <td style="text-align: right;">${entry.synths.toLocaleString()}</td>
                `;
            });
        }
    }


    // =================================
    // INITIALIZATION
    // =================================

    // Check auth status on page load
    (async () => {
        const response = await fetch('/api/game/sync');
        const data = await response.json();

        if (data.success) {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            document.getElementById('playerUsername').textContent = data.player.username;
            player = data.player; // Re-sync will pull the full player data
            await syncPlayerData();
        } else {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('gameSection').style.display = 'none';
            setStatus("Please log in to play.", false);
        }
    })();
</script>

</body>
</html>