<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonecraft Online - Web Sim</title>
    <style>
        :root {
            --bg: #1e1e1e;
            --panel: #2d2d2d;
            --text: #e0e0e0;
            --accent: #4a90e2;
            --accent-hover: #357abd;
            --success: #4caf50;
            --danger: #f44336;
            --border: #404040;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 1000px;
            max-width: 95%;
            margin-top: 20px;
        }

        /* --- Global Elements --- */
        .panel {
            background-color: var(--panel);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        h2 {
            color: var(--accent);
            border-bottom: 2px solid var(--border);
            padding-bottom: 5px;
            margin-top: 0;
        }

        button, .list-btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        button:hover, .list-btn:hover {
            background-color: var(--accent-hover);
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            box-sizing: border-box;
            border: 1px solid var(--border);
            background-color: var(--input-bg, #3d3d3d);
            color: var(--text);
            border-radius: 4px;
        }

        .flex-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .flex-row > * { flex-grow: 1; }

        /* --- Top Bar --- */
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--panel);
        }
        #top-bar .stat {
            font-size: 1.2em;
            color: var(--success);
            font-family: 'Consolas', monospace;
        }

        /* --- Main Layout --- */
        #main-app {
            display: none; /* Hidden until login */
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
        }

        /* --- Tables (Replicating Treeview) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background-color: var(--border);
            color: white;
        }
        tr:hover {
            background-color: #383838;
        }
        tr.selected {
            background-color: var(--accent);
        }
        #ah-table tbody tr { cursor: pointer; }
        #inv-table tbody tr { cursor: pointer; }

        /* --- Auction House Log --- */
        #ah-log {
            height: 100px;
            background-color: #222;
            color: #aaa;
            padding: 10px;
            overflow-y: auto;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Consolas', monospace;
            font-size: 0.8em;
        }
        .log-message {
            margin-bottom: 2px;
        }

        /* --- Modal (Listing Dialog) --- */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: none;
        }
        .modal-content {
            background-color: var(--panel);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border);
            width: 300px;
            border-radius: 8px;
            text-align: center;
        }

        /* --- Synth Result & Status --- */
        #result-label {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            border-radius: 4px;
            margin-top: 10px;
        }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-normal { color: var(--text); }

    </style>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0299695600686963"
      crossorigin="anonymous"></script>
</head>
<body>

<div class="container">
    <div id="ad-unit-top" style="margin-bottom: 20px;">
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-0299695600686963"
            data-ad-slot="5288460043"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
    
    <div id="login-screen" class="panel">
        <h2 style="text-align: center;">BONECRAFT ONLINE</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <div class="flex-row">
            <button onclick="handleLogin()">LOGIN</button>
            <button onclick="handleRegister()" style="background-color: #444;">CREATE ACCOUNT</button>
        </div>
        <p id="auth-status" style="text-align: center; color: var(--text);"></p>
    </div>

    <div id="main-app">
        
        <div id="top-bar" class="panel" style="grid-column: 1 / 3; margin-bottom: 0;">
            <div class="stat" id="gil-label">Gil: 0</div>
            <div class="stat" id="synth-count-label">Total Synths: 0</div>
            <button onclick="handleLogout()" style="width: auto; background-color: var(--danger);">LOGOUT</button>
        </div>

        <div class="panel">
            <h2>Synthesis Studio</h2>
            <select id="recipe-select"></select>
            <button onclick="handleSynth()">Synthesize Item</button>
            <div id="result-label" class="text-normal">Ready to craft...</div>

            <hr style="border-color: var(--border); margin: 20px 0;">

            <h2>Your Inventory</h2>
            <table id="inv-table">
                <thead><tr><th>Item</th><th>Qty</th></tr></thead>
                <tbody></tbody>
            </table>
            <button id="list-item-btn" onclick="openListingModal()" style="margin-top: 10px;" disabled>List Selected on Auction House</button>
        </div>

        <div class="panel">
            <div id="tabs">
                <button onclick="showTab('ah')" style="width: 50%;">Auction House</button>
                <button onclick="showTab('lb')" style="width: 50%; background-color: #444;">Leaderboard</button>
            </div>

            <div id="ah-tab" style="margin-top: 10px;">
                <h2>Auction House</h2>
                <table id="ah-table">
                    <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Seller</th><th>Time</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button id="buy-item-btn" onclick="handleBuy()" style="margin-top: 10px;" disabled>Buy Selected Item(s)</button>
                <div id="ah-log"></div>
            </div>

            <div id="lb-tab" style="margin-top: 10px; display: none;">
                <h2>Global Leaderboard</h2>
                <table id="lb-table">
                    <thead><tr><th>#</th><th>Player Name</th><th>Synths</th><th>Gil</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button onclick="syncLeaderboard()" style="margin-top: 10px;">Refresh Leaderboard</button>
            </div>
        </div>
    </div>

</div>

<div id="listing-modal" class="modal">
    <div class="modal-content">
        <h3>List Item on AH</h3>
        <p id="listing-item-name" style="font-weight: bold;"></p>
        
        <label>Quantity:</label>
        <select id="listing-qty-select" onchange="updateListingPrice()"></select>
        
        <label>Suggested Unit Price (Gil): <span id="suggested-unit-price"></span></label>
        
        <label>Total Price for Stack:</label>
        <input type="number" id="listing-price-input" placeholder="Total Price" min="1">
        
        <div class="flex-row">
            <button onclick="confirmListing()">List</button>
            <button onclick="closeListingModal()" style="background-color: #555;">Cancel</button>
        </div>
        <p id="listing-status" style="color: var(--text);"></p>
    </div>
</div>

<script>
// Global state variables
let player = null;
let recipes = [];
let listings = [];
let selectedInventoryItem = null; // for listing
let selectedAHListing = null; // for buying
let defaultUnitPrices = {}; // Caching unit prices for materials/recipes

// --- Utility Functions ---

function fetchAPI(endpoint, method = 'GET', data = null) {
    const options = {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        }
    };
    if (data) {
        options.body = JSON.stringify(data);
    }
    return fetch(`/api/${endpoint}`, options)
        .then(response => response.json());
}

function logMessage(msg) {
    const log = document.getElementById('ah-log');
    const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const p = document.createElement('p');
    p.classList.add('log-message');
    p.textContent = `[${time}] ${msg}`;
    log.prepend(p);
    // Keep log short
    if (log.children.length > 20) {
        log.lastChild.remove();
    }
}

function formatGil(amount) {
    return new Intl.NumberFormat('en-US').format(amount);
}

function getBasePrice(itemName) {
    // Check recipes (crafted items)
    for (const r of recipes) {
        if (itemName.includes(r.name)) {
            let price = r.price;
            if (itemName.includes("HQ")) price *= 3; 
            return price;
        }
    }
    // Check materials (same logic as app.py)
    if (defaultUnitPrices[itemName]) return defaultUnitPrices[itemName];
    
    return 100; // Default low price
}


// --- UI Initialization and Toggle ---

function checkAuth() {
    // Check if a session cookie exists (by trying to sync)
    fetchAPI('game/sync')
        .then(data => {
            if (data.success) {
                player = data.player;
                recipes = data.recipes;
                recipes.forEach(r => {
                    // Populate suggested prices cache
                    defaultUnitPrices[r.name] = r.price;
                    defaultUnitPrices[`HQ ${r.name} (+1)`] = r.price * 3;
                });
                
                // Material prices (from app.py logic)
                defaultUnitPrices["Bone Chip"] = 100; defaultUnitPrices["Seashell"] = 100;
                defaultUnitPrices["Chicken Bone"] = 500; defaultUnitPrices["Sheep Tooth"] = 500; defaultUnitPrices["Giant Femur"] = 500;
                defaultUnitPrices["Beetle Shell"] = 1500; defaultUnitPrices["Beetle Jaw"] = 1500; defaultUnitPrices["Ram Horn"] = 1500;
                defaultUnitPrices["Turtle Shell"] = 3000; defaultUnitPrices["Scorpion Shell"] = 3000;
                defaultUnitPrices["Demon Horn"] = 8000; defaultUnitPrices["Black Tiger Fang"] = 8000; defaultUnitPrices["Coral Fragment"] = 8000;
                defaultUnitPrices["Wyvern Scales"] = 25000; defaultUnitPrices["Titanictus Shell"] = 25000; defaultUnitPrices["Gavial Fish"] = 25000;

                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'grid';
                initUI();
            } else {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            }
        })
        .catch(() => {
            // Assume offline or server down
            document.getElementById('auth-status').textContent = 'Server connection error.';
        });
}

function initUI() {
    // 1. Populate Recipe Select
    const select = document.getElementById('recipe-select');
    select.innerHTML = '';
    recipes.forEach(r => {
        const option = document.createElement('option');
        option.value = r.name;
        option.textContent = `${r.name} (Material: ${r.material} x${r.qty})`;
        select.appendChild(option);
    });

    // 2. Initial Sync
    syncAll();

    // 3. Set up automatic sync
    setInterval(syncMarketAndLeaderboard, 10000); // Sync AH and LB every 10s
    
    // 4. Set up event listeners for table selection
    document.getElementById('ah-table').addEventListener('click', selectRow);
    document.getElementById('inv-table').addEventListener('click', selectRow);
}

function selectRow(event) {
    const table = event.currentTarget;
    const isAH = table.id === 'ah-table';
    let row = event.target.closest('tr');

    if (!row || row.tagName === 'THEAD') return;

    // Clear previous selection
    table.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
    
    // Select new row
    row.classList.add('selected');

    if (isAH) {
        // Get listing ID (which is the first column's data-id)
        selectedAHListing = listings.find(l => l.id === row.dataset.id);
        document.getElementById('buy-item-btn').disabled = !selectedAHListing;
    } else {
        selectedInventoryItem = row.dataset.item;
        document.getElementById('list-item-btn').disabled = !selectedInventoryItem;
    }
}

function showTab(tab) {
    document.getElementById('ah-tab').style.display = tab === 'ah' ? 'block' : 'none';
    document.getElementById('lb-tab').style.display = tab === 'lb' ? 'block' : 'none';
    // Update button visual state if needed
}

// --- Sync Functions ---

function syncAll() {	
    syncPlayerData(player); // <-- FIX: Pass the dictionary directly	
    syncMarket();	
    syncLeaderboard();	
}

function syncPlayerData(data) {
    player = data;
    document.getElementById('gil-label').textContent = `Gil: ${formatGil(player.gil)}`;
    document.getElementById('synth-count-label').textContent = `Total Synths: ${player.total_synths}`;
    
    const invBody = document.getElementById('inv-table').querySelector('tbody');
    invBody.innerHTML = '';
    selectedInventoryItem = null;
    document.getElementById('list-item-btn').disabled = true;

    for (const item in player.inventory) {
        if (player.inventory[item] > 0) {
            const row = invBody.insertRow();
            row.dataset.item = item;
            row.insertCell().textContent = item;
            row.insertCell().textContent = player.inventory[item];
        }
    }
}

function syncMarket() {
    fetchAPI('ah/market')
        .then(data => {
            if (data.success) {
                listings = data.listings;
                const ahBody = document.getElementById('ah-table').querySelector('tbody');
                ahBody.innerHTML = '';
                selectedAHListing = null;
                document.getElementById('buy-item-btn').disabled = true;

                data.listings.forEach(l => {
                    const row = ahBody.insertRow();
                    row.dataset.id = l.id;
                    row.insertCell().textContent = l.item;
                    row.insertCell().textContent = l.qty;
                    row.insertCell().textContent = formatGil(l.price);
                    row.insertCell().textContent = l.seller;
                    row.insertCell().textContent = l.time.split(' ')[1]; // Time only
                    if (l.seller === player.name) {
                        row.style.backgroundColor = 'rgba(74, 144, 226, 0.2)'; // Highlight own listing
                    }
                });
            }
        });
}

function syncLeaderboard() {
    fetchAPI('game/leaderboard')
        .then(data => {
            if (data.success) {
                const lbBody = document.getElementById('lb-table').querySelector('tbody');
                lbBody.innerHTML = '';

                data.leaderboard.forEach((p, index) => {
                    const row = lbBody.insertRow();
                    row.insertCell().textContent = index + 1;
                    row.insertCell().textContent = p.name;
                    row.insertCell().textContent = formatGil(p.synths);
                    row.insertCell().textContent = formatGil(p.gil);
                    if (p.name === player.name) {
                        row.style.color = 'var(--accent)';
                        row.style.fontWeight = 'bold';
                    }
                });
            }
        });
}

function syncMarketAndLeaderboard() {
    syncMarket();
    syncLeaderboard();
}

// --- Auth Handlers ---

function handleLogin() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const status = document.getElementById('auth-status');
    status.textContent = 'Logging in...';

    fetchAPI('auth/login', 'POST', { username, password })
        .then(data => {
            if (data.success) {
                status.textContent = data.message;
                checkAuth();
            } else {
                status.textContent = data.message;
            }
        });
}

function handleRegister() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const status = document.getElementById('auth-status');
    status.textContent = 'Creating account...';

    fetchAPI('auth/register', 'POST', { username, password })
        .then(data => {
            status.textContent = data.message;
            if (data.success) {
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                status.style.color = 'var(--success)';
            } else {
                status.style.color = 'var(--danger)';
            }
        });
}

function handleLogout() {
    fetchAPI('auth/logout', 'POST').then(() => {
        window.location.reload();
    });
}

// --- Game Handlers ---

function handleSynth() {
    const recipeName = document.getElementById('recipe-select').value;
    const resultLabel = document.getElementById('result-label');
    resultLabel.textContent = 'Synthesizing...';
    resultLabel.className = 'text-normal';

    fetchAPI('game/synth', 'POST', { recipe_name: recipeName })
        .then(data => {
            if (data.success) {
                syncPlayerData(data.player);
                resultLabel.textContent = data.message;
                resultLabel.className = data.result === 'HQ' ? 'text-success' : data.result === 'BREAK' ? 'text-danger' : 'text-normal';
                if (data.result !== 'BREAK') {
                    // Refresh AH in case a synth item is now available to list
                    syncMarket();
                }
            } else {
                resultLabel.textContent = data.message;
                resultLabel.className = 'text-danger';
            }
        });
}

function handleBuy() {
    if (!selectedAHListing) return;
    
    if (player.gil < selectedAHListing.price) {
        logMessage("ERROR: Insufficient Gil to complete purchase.");
        return;
    }

    const listingId = selectedAHListing.id;
    logMessage(`Attempting to buy ${selectedAHListing.qty}x ${selectedAHListing.item}...`);

    fetchAPI('ah/buy', 'POST', { listing_id: listingId })
        .then(data => {
            if (data.success) {
                syncPlayerData(data.player);
                logMessage(data.message);
            } else {
                logMessage(`ERROR: ${data.message}`);
            }
            // Always refresh market after a buy attempt
            syncMarket();
        });
}

// --- Listing Modal Logic (with x12 stacks) ---

let currentItemMaxQty = 0;
let currentItemBasePrice = 0;

function openListingModal() {
    if (!selectedInventoryItem) return;

    currentItemMaxQty = player.inventory[selectedInventoryItem];
    currentItemBasePrice = getBasePrice(selectedInventoryItem);

    document.getElementById('listing-item-name').textContent = selectedInventoryItem;
    document.getElementById('suggested-unit-price').textContent = formatGil(currentItemBasePrice);
    document.getElementById('listing-status').textContent = '';
    
    const qtySelect = document.getElementById('listing-qty-select');
    qtySelect.innerHTML = '';
    
    let allowedQtys = [1, 6, 12].filter(q => q <= currentItemMaxQty);
    if (!allowedQtys.includes(currentItemMaxQty) && currentItemMaxQty > 0) {
        allowedQtys.push(currentItemMaxQty);
    }
    allowedQtys.sort((a, b) => a - b);
    
    if (allowedQtys.length === 0) {
        logMessage("ERROR: Cannot list an item you don't have.");
        return;
    }

    allowedQtys.forEach(qty => {
        const option = document.createElement('option');
        option.value = qty;
        option.textContent = qty;
        qtySelect.appendChild(option);
    });

    // Default to the highest stack if possible, otherwise max qty
    let defaultQty = 1;
    if (currentItemMaxQty >= 12) defaultQty = 12;
    else if (currentItemMaxQty >= 6) defaultQty = 6;
    else defaultQty = currentItemMaxQty;
    
    qtySelect.value = defaultQty;
    
    // Set default price based on the initial quantity
    document.getElementById('listing-price-input').value = currentItemBasePrice * defaultQty;

    document.getElementById('listing-modal').style.display = 'block';
}

function closeListingModal() {
    document.getElementById('listing-modal').style.display = 'none';
}

function updateListingPrice() {
    const qty = parseInt(document.getElementById('listing-qty-select').value);
    const priceInput = document.getElementById('listing-price-input');
    // Auto-fill price based on suggested unit price and selected quantity
    priceInput.value = currentItemBasePrice * qty;
}

function confirmListing() {
    const item = selectedInventoryItem;
    const qty = parseInt(document.getElementById('listing-qty-select').value);
    const price = parseInt(document.getElementById('listing-price-input').value);
    const status = document.getElementById('listing-status');

    if (isNaN(price) || price <= 0 || isNaN(qty) || qty <= 0 || qty > currentItemMaxQty) {
        status.textContent = 'Invalid price or quantity.';
        status.style.color = 'var(--danger)';
        return;
    }

    status.textContent = 'Listing...';
    status.style.color = 'var(--text)';

    fetchAPI('ah/list', 'POST', { 
        item: item, 
        price: price, 
        qty: qty 
    })
    .then(data => {
        if (data.success) {
            logMessage(data.message);
            syncAll(); // Resync player inventory and AH
            closeListingModal();
        } else {
            status.textContent = data.message;
            status.style.color = 'var(--danger)';
        }
    })
    .catch(() => {
        status.textContent = 'Network error. Could not list item.';
        status.style.color = 'var(--danger)';
    });
}

// Start the check when the page loads
document.addEventListener('DOMContentLoaded', checkAuth);

</script>
</body>
</html>